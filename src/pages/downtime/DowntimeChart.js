// DowntimeChart.jsx
import React, { Component } from 'react';
import { connect } from "react-redux";

import { BarChart } from '@mui/x-charts/BarChart';
import { PieChart } from '@mui/x-charts/PieChart';
import {
  Box, Grid, TextField, MenuItem, Paper, Typography, Stack,
  InputAdornment, IconButton, List, ListItem, Chip
} from '@mui/material';
import Autocomplete from '@mui/material/Autocomplete';
import { 
  Search as SearchIcon, 
  Clear as ClearIcon,
  PieChart as PieChartIcon,
  BarChart as BarChartIcon
} from '@mui/icons-material';

import AccessTimeIcon from '@mui/icons-material/AccessTime';
import AssignmentIcon from '@mui/icons-material/Assignment';
import TimelineIcon from '@mui/icons-material/Timeline';
import BuildIcon from '@mui/icons-material/Build';

import s from './DowntimeChart.module.scss';

// Î¶¨ÎçïÏä§ÏóêÏÑú ÏÉâÏÉÅ ÏÉÅÌÉú Î∂àÎü¨Ïò¥
import { selectThemeHex, selectThemeKey } from '../../reducers/layout';

function mapStateToProps(state) {
  return {
    themeHex: selectThemeHex(state),
    themeKey: selectThemeKey(state), 
  };
}

class DowntimeChart extends Component {
  constructor(props) {
    super(props);

    const DEFAULT_END = '2025-06-30';
    const jan1 = new Date(new Date().getFullYear(), 0, 1).toLocaleDateString('sv-SE');

    this.DEFAULT_END = DEFAULT_END;
    this.PIE_TOP_N = 5;
    this.PIE_WITH_OTHERS = true;

    this.state = {
      loading: false,
      error: null,

      // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞
      formattedData: [],

      // Í≥µÌÜµ ÌïÑÌÑ∞(ÌîÑÎ†àÏä§+Í∏∞Í∞Ñ)
      kpiFilters: { start_work_date: jan1, end_work_date: DEFAULT_END, press: '1500T' },
      kpiSummary: { total: 0, count: 0, avg: 0, topName: '-', topValue: 0 },

      // ÏûêÏû¨Î≤àÌò∏
      itemCodeOptions: [],
      chartItemCode: '76121-G9000-F1',
      itemSearch: '76121-G9000-F1', // üîç Í≤ÄÏÉâÏ∞ΩÏùò Ïã§Ï†ú ÌëúÏãúÍ∞í(Ïú†Ï†Ä ÏûÖÎ†•)

      // ÏãúÍ∞ÅÌôî Îç∞Ïù¥ÌÑ∞
      chartMonths: [],
      chartSeries: [{ label: 'ÎπÑÍ∞ÄÎèô(Î∂Ñ)', data: [] }],
      pieData: [],
      topNotes: [],
      actionTop: [],
      causeTop: [],
    };
  }

  componentDidMount() {
    this.fetchAllData();
  }

  // ---------- Ïú†Ìã∏ ----------
  fmtNumber = (n) => new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(n ?? 0);
  fmtMinutes = (n) => `${this.fmtNumber(Math.round(n ?? 0))}Î∂Ñ`;

  parseDate = (raw) => {
    if (!raw) return null;
    let s = String(raw).split('T')[0].replace(/[./]/g, '-');
    const m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (m) s = `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
    const d = new Date(`${s}T00:00:00`);
    return isNaN(d) ? null : d;
  };
  monthKey = (d) =>
    d instanceof Date && !isNaN(d) ? `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}` : '';
  tickMonth = (ym) => {
    if (!ym) return '';
    const mm = Number(String(ym).split('-')[1] || 0);
    return `${mm}Ïõî`;
  };

  // ---------- Îç∞Ïù¥ÌÑ∞ Î°úÎìú ----------
  fetchAllData = async () => {
    this.setState({ loading: true, error: null });
    try {
      let res = await fetch('http://localhost:8000/smartFactory/downtime_grid/list', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}),
      });

      if (!res.ok) {
        if (res.status === 405) {
          res = await fetch('http://localhost:8000/smartFactory/downtime_grid/list');
        }
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
      }

      const json = await res.json();
      const arr = (Array.isArray(json) && json) || json?.data || json?.result || [];
      const formatted = this.formatApiData(arr);

      const itemCodes = [...new Set(formatted.map(r => (r.itemCode || '').trim()).filter(Boolean))]
        .sort((a, b) => a.localeCompare(b, 'ko'));

      const preferred = '76121-G9000-F1';
      const defaultCode = itemCodes.includes(preferred) ? preferred : (itemCodes[0] || '');

      const kpiSummary = this.computeKPISummary(
        this.applyKpiFilters(formatted, this.state.kpiFilters)
      );

      const { months, data } = this.aggregateMonthlyByItem(
        formatted, defaultCode, this.state.kpiFilters
      );
      const pieData = this.aggregateDowntimeNamePie(
        formatted, defaultCode, this.PIE_TOP_N, this.PIE_WITH_OTHERS, this.state.kpiFilters
      );
      const topNotes = this.summarizeTopNotes(
        formatted, defaultCode, 10, this.state.kpiFilters
      );
      const actionTop = this.summarizeActions(
        formatted, defaultCode, 8, this.state.kpiFilters
      );
      const causeTop = this.summarizeCauses(
        formatted, defaultCode, 8, this.state.kpiFilters
      );

      this.setState({
        loading: false,
        formattedData: formatted,
        itemCodeOptions: itemCodes,
        chartItemCode: defaultCode,
        itemSearch: defaultCode, // üîÑ Í≤ÄÏÉâÏ∞ΩÎèÑ ÎèôÍ∏∞Ìôî
        kpiSummary,
        chartMonths: months,
        chartSeries: [{ label: 'ÎπÑÍ∞ÄÎèô(Î∂Ñ)', data }],
        pieData,
        topNotes,
        actionTop,
        causeTop,
      });
    } catch (e) {
      console.error('[fetchAllData] Error:', e);
      this.setState({ loading: false, error: 'Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®' });
    }
  };

  formatApiData = (apiData) =>
    apiData.map((item, idx) => ({
      id: item.id || idx + 1,
      workDate: this.parseDate(
        item.workDate ?? item.work_date ?? item.start_work_date ?? item['Í∑ºÎ¨¥ÏùºÏûê'] ?? item.date
      ),
      workplace: item.workplace ?? item.ÏûëÏóÖÏû• ?? item.work_place ?? '',
      itemCode: item.itemCode ?? item.ÏûêÏû¨Î≤àÌò∏ ?? item.item_code ?? '',
      downtimeName: item.downtimeName ?? item.ÎπÑÍ∞ÄÎèôÎ™Ö ?? item.downtime_name ?? '',
      downtimeMinutes: Number(item.downtimeMinutes ?? item['ÎπÑÍ∞ÄÎèô(Î∂Ñ)'] ?? item.ÎπÑÍ∞ÄÎèôÎ∂Ñ ?? 0) || 0,
      note: item.note ?? item.ÎπÑÍ≥† ?? '',
    }));

  // ---------- Í≥µÌÜµ ÌïÑÌÑ∞(ÌîÑÎ†àÏä§+Í∏∞Í∞Ñ) ----------
  applyKpiFilters = (rows, f) => {
    const s = f.start_work_date ? this.parseDate(f.start_work_date) : null;
    const e = f.end_work_date ? this.parseDate(f.end_work_date) : null;
    const kw = (x) => String(x || '').toLowerCase();

    return rows.filter((r) => {
      if (r.workDate) {
        if (s && r.workDate < s) return false;
        if (e && r.workDate > e) return false;
      }
      if (f.press && f.press.trim()) {
        if (!kw(r.workplace).includes(kw(f.press))) return false;
      }
      return true;
    });
  };

  computeKPISummary = (rows) => {
    const total = rows.reduce((a, r) => a + (r.downtimeMinutes || 0), 0);
    const count = rows.length;
    const avg = count ? total / count : 0;

    const by = new Map();
    rows.forEach((r) => {
      const k = (r.downtimeName || '(ÏóÜÏùå)').trim();
      by.set(k, (by.get(k) || 0) + (r.downtimeMinutes || 0));
    });
    let topName = '-', topValue = 0;
    if (by.size) {
      const [n, v] = [...by.entries()].sort((a, b) => b[1] - a[1])[0];
      topName = n;
      topValue = v;
    }
    return { total, count, avg, topName, topValue };
  };

  ensureValidRange = (f) => {
    const s = this.parseDate(f.start_work_date);
    const e = this.parseDate(f.end_work_date);
    if (s && e && s > e) {
      return { ...f, end_work_date: f.start_work_date };
    }
    return f;
  };

  // KPI/Ï∞®Ìä∏ ÎèôÏãú Í∞±Ïã†
  onKpiChange = (k) => (e) => {
    let next = { ...this.state.kpiFilters, [k]: e.target.value };
    next = this.ensureValidRange(next);

    const base = this.applyKpiFilters(this.state.formattedData, next);
    const kpiSummary = this.computeKPISummary(base);

    const code = this.state.chartItemCode;
    const { months, data } = this.aggregateMonthlyByItem(this.state.formattedData, code, next);
    const pieData = this.aggregateDowntimeNamePie(
      this.state.formattedData, code, this.PIE_TOP_N, this.PIE_WITH_OTHERS, next
    );
    const topNotes = this.summarizeTopNotes(this.state.formattedData, code, 10, next);
    const actionTop = this.summarizeActions(this.state.formattedData, code, 8, next);
    const causeTop = this.summarizeCauses(this.state.formattedData, code, 8, next);

    this.setState({
      kpiFilters: next,
      kpiSummary,
      chartMonths: months,
      chartSeries: [{ label: 'ÎπÑÍ∞ÄÎèô(Î∂Ñ)', data }],
      pieData,
      topNotes,
      actionTop,
      causeTop,
    });
  };

  // ---------- ÏûêÏû¨ ÏûêÎèôÏôÑÏÑ± ----------
  // ÏûÖÎ†•Ïñ¥ Í∏∞Ï§Ä Î∂ÄÎ∂ÑÏùºÏπò Ï†ïÎ†¨
  rankItemOptions = (options, inputValue) => {
    if (!inputValue) return options.slice(0, 20);
    const q = inputValue.toLowerCase();
    return options
      .map(o => ({ o, idx: o.toLowerCase().indexOf(q) }))
      .filter(x => x.idx >= 0)
      .sort((a, b) => a.idx - b.idx || a.o.length - b.o.length)
      .map(x => x.o)
      .slice(0, 20);
  };

  // ÏÑ†ÌÉù/ÏûÖÎ†• ÌôïÏ†ï Ïãú Ï∞®Ìä∏ Í∞±Ïã†
  commitItemCode = (code) => {
    if (!code) return;
    const { itemCodeOptions, kpiFilters } = this.state;
    const lower = code.toLowerCase();
    const exact = itemCodeOptions.find(c => c.toLowerCase() === lower);
    const fallback = itemCodeOptions.find(c => c.toLowerCase().includes(lower));
    const selected = exact || fallback;
    if (!selected) return;

    const { months, data } = this.aggregateMonthlyByItem(this.state.formattedData, selected, kpiFilters);
    const pieData = this.aggregateDowntimeNamePie(this.state.formattedData, selected, this.PIE_TOP_N, this.PIE_WITH_OTHERS, kpiFilters);
    const topNotes = this.summarizeTopNotes(this.state.formattedData, selected, 10, kpiFilters);
    const actionTop = this.summarizeActions(this.state.formattedData, selected, 8, kpiFilters);
    const causeTop = this.summarizeCauses(this.state.formattedData, selected, 8, kpiFilters);

    this.setState({
      chartItemCode: selected,
      itemSearch: selected,
      chartMonths: months,
      chartSeries: [{ label: 'ÎπÑÍ∞ÄÎèô(Î∂Ñ)', data }],
      pieData,
      topNotes,
      actionTop,
      causeTop,
    });
  };

  clearItemSearch = () => {
    // ‚úÖ ÏûÖÎ†•Ï∞ΩÎßå Íπ®ÎÅóÌïòÍ≤å Ï¥àÍ∏∞Ìôî (Ï∞®Ìä∏ ÏÑ†ÌÉùÏùÄ Ïú†ÏßÄ)
    this.setState({ itemSearch: '' });
  };

  // ---------- ÏßëÍ≥Ñ ----------
  aggregateMonthlyByItem = (rows, itemCode, kpiFilters = null) => {
    if (!itemCode) return { months: [], data: [] };
    let src = rows;
    if (kpiFilters) src = this.applyKpiFilters(src, kpiFilters);

    const m = new Map();
    src.forEach((r) => {
      if ((r.itemCode || '').trim() !== itemCode) return;
      const k = this.monthKey(r.workDate);
      if (!k) return;
      m.set(k, (m.get(k) || 0) + (r.downtimeMinutes || 0));
    });
    const months = [...m.keys()].sort();
    const data = months.map((k) => m.get(k));
    return { months, data };
  };

  aggregateDowntimeNamePie = (rows, itemCode, topN = 5, withOthers = true, kpiFilters = null) => {
    if (!itemCode) return [];
    let src = rows;
    if (kpiFilters) src = this.applyKpiFilters(src, kpiFilters);

    const m = new Map();
    src.forEach((r) => {
      if ((r.itemCode || '').trim() !== itemCode) return;
      const k = (r.downtimeName || '(ÎπÑÍ∞ÄÎèôÎ™ÖÏóÜÏùå)').trim();
      m.set(k, (m.get(k) || 0) + (r.downtimeMinutes || 0));
    });

    if (!m.size) return [];

    const sorted = [...m.entries()].sort((a, b) => b[1] - a[1]);
    const top = sorted.slice(0, Math.max(0, topN));
    const othersSum = sorted.slice(topN).reduce((acc, [, v]) => acc + v, 0);

    const data = top.map(([label, value], i) => ({ id: i, label, value }));
    if (withOthers && othersSum > 0) data.push({ id: data.length, label: 'Í∏∞ÌÉÄ', value: othersSum });
    return data;
  };

  // ---------- ÎπÑÍ≥† Ï†ïÍ∑úÌôî/ÏöîÏïΩ ----------
  normalizeNote = (txt) => {
    if (!txt) return '';
    let t = String(txt).trim();

    t = t
      .replace(/\s+/g, ' ')
      .replace(/\b(\d{1,2}):\d{2}(?:-\d{1,2}:\d{2})?\b/g, '')
      .replace(/\b\d+\s*EA\b/ig, '')
      .replace(/\b\d+\s*Ìöå\b/g, '')
      .replace(/[-‚Äì‚Äî]+/g, ' ')
      .replace(/\s{2,}/g, ' ')
      .trim();

    t = t
      .replace(/\bOP\s*0?(\d{1,2})\b/ig, 'OP$1')
      .replace(/\bR#?\s*(\d)\b/ig, 'R#$1')
      .replace(/\bP#?\s*(\d)\b/ig, 'P#$1');

    const repl = [
      [/ÏÑ∏Ï†ï|ÏÑ∏Ï≤ô/g, 'Ï≤≠ÏÜå'],
      [/ÍµêÌôò/g, 'ÍµêÏ≤¥'],
      [/Î¶¨Î∂ÄÌåÖ|Ïû¨Í∏∞Îèô/g, 'Ïû¨Î∂ÄÌåÖ'],
      [/Î∞úÎûÄÏä§\s*Î∏îÎ°ù?/g, 'Î∞úÎûÄÏä§Î∏îÎ°ù'],
      [/Ïñ∏Î°úÎî©\s*ÌååÌä∏\s*Í∞êÏßÄ\s*Ïù¥ÏÉÅ/g, 'Ïñ∏Î°úÎî© ÏÑºÏÑú Ïù¥ÏÉÅ'],
      [/Ìã∞Ïπ≠ÏàòÏ†ï/g, 'Ìã∞Ïπ≠ ÏàòÏ†ï'],
      [/Î¨¥ÎπôÎ≥ÄÍ≤Ω/g, 'Î¨¥Îπô Î≥ÄÍ≤Ω'],
    ];
    repl.forEach(([re, to]) => { t = t.replace(re, to); });

    return t.trim();
  };

  summarizeTopNotes = (rows, itemCode, topN = 10, kpiFilters = null) => {
    let src = rows;
    if (kpiFilters) src = this.applyKpiFilters(src, kpiFilters);

    const map = new Map();
    src.forEach((r) => {
      if ((r.itemCode || '').trim() !== itemCode) return;
      const norm = this.normalizeNote(r.note || '');
      if (!norm || norm.length < 2) return;
      const cur = map.get(norm) || { count: 0, minutes: 0 };
      map.set(norm, { count: cur.count + 1, minutes: cur.minutes + (r.downtimeMinutes || 0) });
    });
    return [...map.entries()]
      .map(([text, v]) => ({ text, ...v }))
      .sort((a, b) => b.count - a.count || b.minutes - a.minutes)
      .slice(0, topN);
  };

  summarizeActions = (rows, itemCode, topN = 10, kpiFilters = null) => {
    let src = rows;
    if (kpiFilters) src = this.applyKpiFilters(src, kpiFilters);

    const rules = [
      ['Ï≤≠ÏÜå', /(Ï≤≠ÏÜå|ÏÑ∏Ï≤ô|ÏÑ∏Ï†ï)/],
      ['ÍµêÏ≤¥', /(ÍµêÏ≤¥|ÍµêÌôò)/],
      ['Ï†êÍ≤Ä', /(Ï†êÍ≤Ä|ÌôïÏù∏|Ï≤¥ÌÅ¨|ÌôïÎ≥¥)/],
      ['Ï°∞Ï†ï', /(Ï°∞Ï†ï|Ï°∞Ï†à|ÏÖãÌåÖ|ÏÑ∏ÌåÖ|Î∞úÎûÄÏä§Î∏îÎ°ù|Ïã¨\s*Ï°∞Ï†ï)/],
      ['ÏàòÎ¶¨/Ï†ïÎπÑ', /(ÏàòÎ¶¨|Î≥¥Ïàò|Ï†ïÎπÑ|ÏÇ¨ÏÉÅ)/],
      ['Ìã∞Ïπ≠ ÏàòÏ†ï', /(Ìã∞Ïπ≠\s*ÏàòÏ†ï|Ìã∞Ïπ≠|Îç∞Ïù¥ÌÑ∞\s*ÏàòÏ†ï)/],
      ['Ïú§Ìôú', /(Ïú§Ìôú|Í∑∏Î¶¨Ïä§|Ïò§Ïùº|Í∏âÏú†)/],
      ['Ïû¨Î∂ÄÌåÖ/Ïû¨Í∞ÄÎèô', /(Ïû¨Î∂ÄÌåÖ|Î¶¨ÏÖã|Ïû¨Í∞ÄÎèô|Ïû¨Í∏∞Îèô)/],
      ['ÏÑ†Î≥Ñ/Ïù¥Í¥Ä', /(ÏÑ†Î≥Ñ|Ïù¥Í¥Ä)/],
      ['ÏàòÎèôÏ°∞Ïûë/ÏàòÎèôÍµêÏ≤¥', /(ÏàòÎèôÏ°∞Ïûë|ÏàòÎèôÍµêÏ≤¥|ÏûêÎèôÍµêÌôò\s*Î∂à)/],
    ];
    const agg = new Map();
    const inc = (k, mins) => {
      const v = agg.get(k) || { count: 0, minutes: 0 };
      agg.set(k, { count: v.count + 1, minutes: v.minutes + (mins || 0) });
    };
    src.forEach((r) => {
      if ((r.itemCode || '').trim() !== itemCode) return;
      const t = String(r.note || '');
      let matched = false;
      for (const [label, re] of rules) {
        if (re.test(t)) {
          inc(label, r.downtimeMinutes);
          matched = true;
        }
      }
      if (!matched && t.trim()) inc('Í∏∞ÌÉÄ', r.downtimeMinutes);
    });
    return [...agg.entries()]
      .map(([label, v]) => ({ label, ...v }))
      .sort((a, b) => b.minutes - a.minutes || b.count - a.count)
      .slice(0, topN);
  };

  summarizeCauses = (rows, itemCode, topN = 10, kpiFilters = null) => {
    let src = rows;
    if (kpiFilters) src = this.applyKpiFilters(src, kpiFilters);

    const rules = [
      ['ÏßÑÍ≥µ Ïù¥ÏÉÅ', /(ÏßÑÍ≥µÏù¥ÏÉÅ|ÏßÑÍ≥µÏóêÎü¨|ÏßÑÍ≥µÏÜî\s*ÏûëÎèô\s*Î∂à|ÏßÑÍ≥µ\s*ÏßÄÏó∞)/],
      ['2Îß§ Í∞êÏßÄ', /(2Îß§Í∞êÏßÄ|ÎëêÎß§\s*Í∞êÏßÄ)/],
      ['ÎπÑÏ†Ñ Ïù¥ÏÉÅ', /(ÎπÑÏ†Ñ\s*Ïù¥ÏÉÅ|Ïò§\s*Ï¥¨ÏòÅ)/],
      ['Ïñ∏Î°úÎî©/ÌååÌä∏Í∞êÏßÄ Ïù¥ÏÉÅ', /(Ïñ∏Î°úÎî©\s*ÏÑºÏÑú|ÌååÌä∏Í∞êÏßÄ\s*Ïù¥ÏÉÅ)/],
      ['ÌïòÏÇ¨Ï†ê Ïù¥ÌÉà/Î∂àÏùºÏπò', /(ÌïòÏÇ¨Ï†ê\s*(Ïù¥ÌÉà|Î∂àÏùºÏπò))/],
      ['QDC ÌõÑÏßÑ/Ï≤¥Í≤∞ Î∂à', /(QDC.*(ÌõÑÏßÑ|Ï≤¥Í≤∞).*(Î∂à|ÏßÄÏó∞))/],
      ['Ïä§ÌÅ¨Îû© Ï∑®Ï∂ú/ÎßâÌûò', /(Ïä§ÌÅ¨Îû©\s*(Ï∑®Ï∂ú\s*Î∂à|ÎßâÌûò|Ï†ïÏ≤¥))/],
      ['ÌÅ¨Îûô/Ï†ëÌûò/Ï∞çÌûò/ÎÑ•', /(ÌÅ¨Îûô|Ï†ëÌûò|Ï∞çÌûò|ÏöîÏ≤†|ÎÑ•)/],
      ['Î¨¥Îπô/ÏïàÏ∞© Î¨∏Ï†ú', /(Î¨¥Îπô.*(ÏßÄÏó∞|Ïù¥ÏÉÅ|Ïù∏ÏûÖ\s*Î∂à)|ÏïàÏ∞©\s*Î∂à)/],
      ['Ïù∏Î≤ÑÌÑ∞/Î™®ÌÑ∞ Ïù¥ÏÉÅ', /(Ïù∏Î≤ÑÌÑ∞\s*Ïù¥ÏÉÅ|Î™®ÌÑ∞.*Ïù¥ÏÉÅ|Í∞êÏÜçÍ∏∞)/],
      ['Í∏àÌòï/ÏÑºÏÑú Ïù¥ÏÉÅ', /(Í∏àÌòï\s*ÏÑºÏÑú|Í∏àÌòï\s*Ï≤≠ÏÜå|Í≤åÏù¥ÏßÄ|ÏÑºÏÑú\s*Ïù¥ÏÉÅ)/],
      ['Í≥µÏïï/ÏóêÏñ¥/Ïª¥ÌîÑÎ†àÏÑú', /(ÏóêÏñ¥\s*Ïïï|Î©îÏù∏\s*ÏóêÏñ¥|ÏΩ§ÌîÑÎ†àÏÑú|Ïª¥ÌîÑÎ†àÏÖî)/],
      ['Ïª®Î≤†Ïñ¥/Î≤®Ìä∏ Ïù¥ÏÉÅ', /(Ïª®Î≤†Ïñ¥|Î≤®Ìä∏)\s*(Ïù¥ÏÉÅ|Ï†ïÏßÄ|ÏûëÎèô\s*Î∂à)/],
      ['Ï∞®Í∏∞ Í∏àÌòï ÎØ∏ÎåÄÍ∏∞', /(Ï∞®Í∏∞\s*Í∏àÌòï.*(ÎØ∏ÎåÄÍ∏∞|Î∂ÄÏ°±)|Í∏àÌòï\s*ÎåÄÍ∏∞\s*ÏßÄÏó∞)/],
      ['ÏÇ¨Ïñë ÍµêÏ≤¥/Î≥ÄÍ≤Ω', /(ÏÇ¨Ïñë\s*(ÍµêÏ≤¥|Î≥ÄÍ≤Ω|ÌôïÏù∏))/],
    ];
    const agg = new Map();
    const inc = (k, mins) => {
      const v = agg.get(k) || { count: 0, minutes: 0 };
      agg.set(k, { count: v.count + 1, minutes: v.minutes + (mins || 0) });
    };
    src.forEach((r) => {
      if ((r.itemCode || '').trim() !== itemCode) return;
      const t = String(r.note || '');
      let hit = false;
      for (const [label, re] of rules) {
        if (re.test(t)) {
          inc(label, r.downtimeMinutes);
          hit = true;
        }
      }
      if (!hit && t.trim()) inc('Í∏∞ÌÉÄ', r.downtimeMinutes);
    });
    return [...agg.entries()]
      .map(([label, v]) => ({ label, ...v }))
      .sort((a, b) => b.count - a.count || b.minutes - a.minutes)
      .slice(0, topN);
  };

  // ---------- Render ----------
  render() {
    const {
      loading, error,
      kpiFilters, kpiSummary,
      itemCodeOptions, chartItemCode, chartMonths, chartSeries, pieData,
      topNotes, actionTop, causeTop, itemSearch
    } = this.state;

    const { themeHex } = this.props; // HEXÎßå Í∫ºÎÇ¥ ÏîÄ

    return (
      <div className={s.root} >
        <div className={s.titleCon}>
          <h1 style={{ color: themeHex }}>ÎπÑÍ∞ÄÎèô Îç∞Ïù¥ÌÑ∞ Ï∞®Ìä∏</h1>
          <p className={s.contant}>ÎπÑÍ∞ÄÎèô ÌòÑÌô©ÏùÑ Ï∞®Ìä∏Î°ú ÌïúÎààÏóê ÌååÏïÖÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
        </div>

        {/* KPI + Í≥µÌÜµ ÌïÑÌÑ∞ */}
        <Paper sx={{ p: 3, mb: 3, borderRadius: 2 }}>
          <Typography variant="h6" sx={{ display: 'flex', alignItems: 'center', gap: 1, color: themeHex, mb: 2 }}>
            <PieChartIcon />
            ÎπÑÍ∞ÄÎèô ÌòÑÌô© ÏßÄÌëú
          </Typography>

          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                      mb: 3, p: 2, backgroundColor: 'background.paper', borderRadius: 2, border: '1px solid #e0e0e0' }}>
            {/* ÌîÑÎ†àÏä§ */}
            <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
              <Typography variant="body2" sx={{ fontWeight: 500, minWidth: '120px' }}>
                ÌîÑÎ†àÏä§(ÏûëÏóÖÏû•):
              </Typography>
              <TextField
                select size="small" value={kpiFilters.press} onChange={this.onKpiChange('press')}
                sx={{ backgroundColor: 'background.paper', minWidth: 200,
                      '& .MuiOutlinedInput-root': {
                        '&:hover fieldset': { borderColor: '#4CAF50' },
                        '&.Mui-focused fieldset': { borderColor: '#4CAF50' },
                      }}}
              >
                <MenuItem value="">Ï†ÑÏ≤¥</MenuItem>
                <MenuItem value="1500T">1500T</MenuItem>
                <MenuItem value="1200T">1200T</MenuItem>
                <MenuItem value="1000T">1000T</MenuItem>
                <MenuItem value="1000PT">1000PT</MenuItem>
              </TextField>
            </Box>

            {/* Í∏∞Í∞Ñ */}
            <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
              <Typography variant="body2" sx={{ fontWeight: 500, minWidth: '80px' }}>
                Í∏∞Í∞Ñ ÏÑ†ÌÉù:
              </Typography>
              <TextField type="date" size="small" value={kpiFilters.start_work_date} onChange={this.onKpiChange('start_work_date')}
                sx={{ 
                      backgroundColor: 'background.paper',
                      '& .MuiOutlinedInput-root': {
                        '&:hover fieldset': { borderColor: '#4CAF50' },
                        '&.Mui-focused fieldset': { borderColor: '#4CAF50' },
                  }}}
              />
              <Typography variant="body2" sx={{ color: '#666' }}>~</Typography>
              <TextField type="date" size="small" value={kpiFilters.end_work_date} onChange={this.onKpiChange('end_work_date')}
                sx={{ 
                      backgroundColor: 'background.paper',    
                      '& .MuiOutlinedInput-root': {
                        '&:hover fieldset': { borderColor: '#4CAF50' },
                        '&.Mui-focused fieldset': { borderColor: '#4CAF50' },
                      }}}
              />
            </Box>
          </Box>

          {/* KPI Ïπ¥Îìú */}
          <Grid container spacing={2}>
            {[
              { label: 'Ï¥ù ÎπÑÍ∞ÄÎèô(Î∂Ñ)', value: this.fmtMinutes(kpiSummary.total), icon: <AccessTimeIcon color="warning" /> },
              { label: 'Í±¥Ïàò', value: `${this.fmtNumber(kpiSummary.count)}Í±¥`, icon: <AssignmentIcon color="primary" /> },
              { label: '1Í±¥ ÌèâÍ∑†(Î∂Ñ)', value: this.fmtMinutes(kpiSummary.avg), icon: <TimelineIcon color="success" /> },
              { label: 'ÏµúÎã§ ÎπÑÍ∞ÄÎèôÎ™Ö', value: kpiSummary.topName, icon: <BuildIcon color="error" /> },
            ].map((kpi, i) => (
              <Grid item xs={12} sm={6} md={3} key={i}>
                <Paper 
                  elevation={3} 
                  sx={{ 
                    p: 2, 
                    borderRadius: '16px', 
                    textAlign: 'center',
                    height: 160, 
                    display: 'flex', 
                    flexDirection: 'column', 
                    justifyContent: 'center',
                    "&:hover": {
                        backgroundColor: "#f5f5f5", // hover Ïãú Î∞∞Í≤ΩÏÉâ
                        cursor: "pointer",          // ÎßàÏö∞Ïä§ Ìè¨Ïù∏ÌÑ∞
                      },
                    }}>
                  <Box 
                    sx={{ display: 'flex', justifyContent: 'center', mb: 1 }}>
                    {React.cloneElement(kpi.icon, { fontSize: "large" })}
                  </Box>
                  <Typography variant="overline" sx={{fontSize: '13px', fontWeight: 'bold', color: 'text.secondary'}}>{kpi.label}</Typography>
                  <Typography variant="h4" sx={{ mt: .5, fontSize: '28px', fontWeight: 'bold' }}>{kpi.value}</Typography>
                </Paper>
              </Grid>
            ))}
          </Grid>
        </Paper>

        {/* Ï∞®Ìä∏ + ÏûêÏû¨Î≤àÌò∏ Í≤ÄÏÉâ */}
        <Paper sx={{ p: 3, mb: 3, borderRadius: '16px' }}>
          <Typography variant="h6" sx={{ display: 'flex', alignItems: 'center', gap: 1, color: themeHex, mb: 2 }}>
            <BarChartIcon />
            ÏûêÏû¨Î≥Ñ ÏõîÍ∞Ñ ÎπÑÍ∞ÄÎèô
          </Typography>

          <Box sx={{ display: 'flex', justifyContent: 'flex-end', alignItems: 'center', gap: 2, p: 2,
                      backgroundColor: 'background.paper', borderRadius: 2, border: '1px solid #e0e0e0' }}>
            <Typography variant="body2" sx={{ fontWeight: 500, minWidth: '20px' }}>
              ÏûêÏû¨Î≤àÌò∏:
            </Typography>

            {/* üîç Google Ïä§ÌÉÄÏùº ÏûêÎèôÏôÑÏÑ± (ÏûÖÎ†• Ï†ÑÏö© Ï†úÏñ¥) */}
            <Autocomplete
              freeSolo
              autoHighlight
              openOnFocus
              // ÎÇ¥Ïû• clearÎäî ÎÅÑÍ≥†(Î≤ÑÍ∑∏ Ïú†Î∞ú), Ïª§Ïä§ÌÖÄ X ÏÇ¨Ïö©
              disableClearable
              clearOnEscape
              clearOnBlur={false}
              selectOnFocus
              handleHomeEndKeys
              options={this.rankItemOptions(itemCodeOptions, itemSearch)}
              filterOptions={(x) => x} // Ïö∞Î¶¨Í∞Ä ÏßÅÏ†ë ÌïÑÌÑ∞/Ï†ïÎ†¨Ìï®
              // ‚úÖ ÏûÖÎ†•Í∞íÎßå Ï†úÏñ¥: valueÎäî ÏïÑÏòà Ï£ºÏßÄ ÏïäÏùå(ÏÑ†ÌÉùÍ∞íÏù¥ ÏûÖÎ†•ÏùÑ ÎçÆÏñ¥Ïì∞ÏßÄ ÏïäÎèÑÎ°ù)
              inputValue={itemSearch}
              onInputChange={(e, value) => this.setState({ itemSearch: value })}
              // ÏòµÏÖò ÏÑ†ÌÉù Ïãú Ïª§Î∞ã
              onChange={(e, value) => this.commitItemCode(value)}
              renderInput={(params) => (
                <TextField
                  {...params}
                  size="small"
                  placeholder="ÏûêÏû¨Î≤àÌò∏ Í≤ÄÏÉâ"
                  onFocus={(e) => e.target.select()}              // Ìè¨Ïª§Ïä§ Ïãú Ï†ÑÏ≤¥ ÏÑ†ÌÉù ‚Üí Î∞îÎ°ú ÎçÆÏñ¥Ïì∞Í∏∞
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      this.commitItemCode(this.state.itemSearch);
                    }
                    if (e.key === 'Escape') {
                      e.preventDefault();
                      this.clearItemSearch();
                    }
                  }}
                  InputProps={{
                    ...params.InputProps,
                    startAdornment: (
                      <InputAdornment position="start">
                        <SearchIcon fontSize="small" />
                      </InputAdornment>
                    ),
                    endAdornment: (
                      <>
                        {this.state.itemSearch ? (
                          <InputAdornment position="end">
                            <IconButton
                              size="small"
                              aria-label="clear"
                              onMouseDown={(ev) => ev.preventDefault()} // Ìè¨Ïª§Ïä§ Ïú†ÏßÄ
                              onClick={this.clearItemSearch}
                            >
                              <ClearIcon fontSize="small" />
                            </IconButton>
                          </InputAdornment>
                        ) : null}
                        {params.InputProps.endAdornment /* Autocomplete ÎÇ¥Î∂Ä adornment(loading Îì±) Ïú†ÏßÄ */}
                      </>
                    ),
                  }}
                  sx={{ 
                    backgroundColor: 'background.paper',
                    borderRadius: '8px',
                    minWidth: 220,
                    '& .MuiOutlinedInput-root': {
                      '&:hover fieldset': { borderColor: '#4CAF50' },
                      '&.Mui-focused fieldset': { borderColor: '#4CAF50' },
                    }
                  }}
                />
              )}
              renderOption={(props, option, { inputValue }) => {
                const i = option.toLowerCase().indexOf((inputValue || '').toLowerCase());
                return (
                  <li {...props}>
                    {i >= 0 ? (
                      <>
                        {option.slice(0, i)}
                        <strong>{option.slice(i, i + inputValue.length)}</strong>
                        {option.slice(i + inputValue.length)}
                      </>
                    ) : option}
                  </li>
                );
              }}
              noOptionsText={itemSearch ? 'ÏùºÏπòÌïòÎäî ÏûêÏû¨Î≤àÌò∏Í∞Ä ÏóÜÏñ¥Ïöî' : 'Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî'}
            />
          </Box>

          {/* ÏõîÎ≥Ñ Ìï©Í≥Ñ ÎßâÎåÄÏ∞®Ìä∏ */}
          {!loading && !error && chartItemCode && chartMonths.length > 0 ? (
            <BarChart
              xAxis={[{
                id: 'months',
                scaleType: 'band',
                data: chartMonths,
                label: 'Ïõî',
                valueFormatter: this.tickMonth,
                tickLabelInterval: () => true,
              }]}
              yAxis={[{ label: 'ÎπÑÍ∞ÄÎèô(Î∂Ñ)' }]}
              series={[{
                label: 'ÎπÑÍ∞ÄÎèô(Î∂Ñ)',
                data: chartSeries[0].data,
                valueFormatter: (v) => `${this.fmtNumber(v)}Î∂Ñ`,
                color: themeHex,
              }]}
              barLabel={(item) => `${item.value?.toString()}Î∂Ñ`}
              height={420}
              margin={{ top: 24, right: 24, bottom: 64, left: 64 }}
              borderRadius={8}
              slotProps={{ legend: { hidden: true } }}
            />
          ) : (
            <Box sx={{ height: 200, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'text.secondary' }}>
              ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
            </Box>
          )}

          {/* ÌååÏù¥ + ÎπÑÍ≥† Top */}
          <Grid container spacing={2} sx={{ mb: 2 }}>
            <Grid item xs={12} md={6}>
              <Paper sx={{ p: 2, borderRadius: '16px', height: '100%', display: 'flex',
                            flexDirection: 'column', justifyContent: 'center', alignItems: 'center' }}>
                <Typography variant="h6" sx={{ mb: 1, fontWeight: 600, textAlign: 'center' }}>
                  {chartItemCode} ¬∑ ÎπÑÍ∞ÄÎèôÎ™Ö ÎπÑÏ§ë (Top {this.PIE_TOP_N}{this.PIE_WITH_OTHERS ? ' + Í∏∞ÌÉÄ' : ''})
                </Typography>
                <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', width: '100%' }}>
                  {pieData?.length ? (
                    <PieChart
                      series={[{
                        data: pieData,
                        arcLabel: (it) => it.label,
                        arcLabelMinAngle: 12,
                        innerRadius: 40,
                        paddingAngle: 2,
                      }]}
                      height={360}
                      margin={{ top: 16, right: 16, bottom: 16, left: 16 }}
                      slotProps={{ legend: { direction: 'column', position: { vertical: 'middle', horizontal: 'right' } } }}
                    />
                  ) : (
                    <Box sx={{ height: 200, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'text.secondary' }}>
                      Ìï¥Îãπ ÏûêÏû¨Î≤àÌò∏Ïùò ÎπÑÍ∞ÄÎèôÎ™Ö Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                    </Box>
                  )}
                </Box>
              </Paper>
            </Grid>

            <Grid item xs={12} md={6}>
              <Paper sx={{ p: 2, borderRadius: '16px', height: '100%' }}>
                <Typography variant="h6" sx={{ mb: 1, fontWeight: 600, textAlign: 'center' }}>
                  {chartItemCode} ¬∑ Í∞ÄÏû• ÎßéÏù¥ Îì±Ïû•Ìïú ÎπÑÍ≥†
                </Typography>
                {topNotes.length ? (
                  <List dense>
                    {topNotes.map((n, i) => (
                      <ListItem 
                      key={i} 
                      disableGutters 
                      sx={{
                        "&:hover": {
                          backgroundColor: "#f5f5f5", // hover Ïãú Î∞∞Í≤ΩÏÉâ
                          cursor: "pointer",          // ÎßàÏö∞Ïä§ Ìè¨Ïù∏ÌÑ∞
                        },
                      }}>
                        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                    width: '100%', p: 0.5, borderBottom: '1px solid #f0f0f0' }}>
                          <Box sx={{ fontSize: '0.85rem', fontWeight: 500 }}>
                            {i + 1}. {n.text}
                          </Box>
                          <Stack direction="row" spacing={1} sx={{ minWidth: 85 }}>
                            <Chip size="small" label={`${this.fmtNumber(n.count)}Í±¥`} 
                                  sx={{ minWidth: 45, backgroundColor: '#e3f2fd', color: '#1976d2', fontWeight: 600 }} />
                            <Chip size="small" label={`${this.fmtNumber(n.minutes)}Î∂Ñ`} 
                                  sx={{ minWidth: 45, backgroundColor: '#fce4ec', color: '#d81b60', fontWeight: 600 }} />
                          </Stack>
                        </Box>
                      </ListItem>
                    ))}
                  </List>
                ) : (
                  <Typography color="text.secondary">Î∞òÎ≥µÏ†ÅÏúºÎ°ú Îì±Ïû•Ìïú ÎπÑÍ≥†Í∞Ä ÏóÜÏäµÎãàÎã§.</Typography>
                )}
              </Paper>
            </Grid>
          </Grid>

          {/* ÌñâÎèô/ÏõêÏù∏ ÏöîÏïΩ */}
          <Grid container spacing={2}>
            <Grid item xs={12} md={6}>
              <Paper sx={{ p: 2, borderRadius: '16px', height: '100%' }}>
                <Typography variant="subtitle1" sx={{ mb: 1, fontWeight: 600, textAlign: 'center' }}>
                  Ï°∞Ïπò Ïú†Ìòï Top (ÎàÑÏ†Å Î∂Ñ)
                </Typography>
                {actionTop.length ? (
                  <BarChart
                    xAxis={[{ id: 'act', scaleType: 'band', data: actionTop.map((d) => d.label) }]}
                    yAxis={[{ label: 'ÎàÑÏ†Å Î∂Ñ' }]}
                    series={[{ 
                      data: actionTop.map((d) => d.minutes), 
                      valueFormatter: (v) => `${this.fmtNumber(v)}Î∂Ñ`,
                      color: themeHex
                    }]}
                    height={320}
                    margin={{ top: 16, right: 24, bottom: 64, left: 64 }}
                    borderRadius={8}
                    slotProps={{ legend: { hidden: true } }}
                  />
                ) : (
                  <Typography color="text.secondary">ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</Typography>
                )}
              </Paper>
            </Grid>

            <Grid item xs={12} md={6}>
              <Paper sx={{ p: 2, borderRadius: '16px', height: '100%' }}>
                <Typography variant="subtitle1" sx={{ mb: 1, fontWeight: 600, textAlign: 'center' }}>
                  ÏõêÏù∏/Ï¶ùÏÉÅ Top (Í±¥Ïàò)
                </Typography>
                {causeTop.length ? (
                  <BarChart
                    xAxis={[{ id: 'cause', scaleType: 'band', data: causeTop.map((d) => d.label) }]}
                    yAxis={[{ label: 'Í±¥Ïàò' }]}
                    series={[{ 
                      data: causeTop.map((d) => d.count), 
                      valueFormatter: (v) => `${this.fmtNumber(v)}Í±¥`,
                      color: themeHex
                    }]}
                    height={320}
                    margin={{ top: 16, right: 24, bottom: 64, left: 64 }}
                    borderRadius={8}
                    slotProps={{ legend: { hidden: true } }}
                  />
                ) : (
                  <Typography color="text.secondary">ÌëúÏãúÌï† Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</Typography>
                )}
              </Paper>
            </Grid>
          </Grid>

          {loading && <Typography sx={{ mt: 2 }}>Î°úÎî© Ï§ë‚Ä¶</Typography>}
          {error && <Typography color="error" sx={{ mt: 2 }}>{error}</Typography>}
        </Paper>

      </div>
    );
  }
}

export default connect(mapStateToProps)(DowntimeChart);